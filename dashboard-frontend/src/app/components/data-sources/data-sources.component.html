<div class="data-sources-container">
  <!-- Header -->
  <header class="ds-header">
    <div class="header-content">
      <div class="header-title">
        <h1>üîå Data Sources</h1>
        <p>Connect to databases, APIs, cloud services, and SaaS platforms</p>
      </div>
      <div class="header-actions">
        <button class="mat-btn mat-btn-filled" (click)="toggleCreateForm()">
          <span>‚ûï</span> Add Data Source
        </button>
        <button class="mat-btn mat-btn-outlined" (click)="goBack()">
          ‚Üê Back to Admin
        </button>
      </div>
    </div>
  </header>

  <!-- Statistics Panel -->
  <div class="statistics-panel" *ngIf="statistics">
    <div class="stat-card">
      <div class="stat-icon">üìä</div>
      <div class="stat-content">
        <div class="stat-value">{{ statistics.total }}</div>
        <div class="stat-label">Total Sources</div>
      </div>
    </div>
    <div class="stat-card connected">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-content">
        <div class="stat-value">{{ statistics.connected }}</div>
        <div class="stat-label">Connected</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üîå</div>
      <div class="stat-content">
        <div class="stat-value">{{ getTypeCount() }}</div>
        <div class="stat-label">Types Used</div>
      </div>
    </div>
  </div>

  <!-- Template Selector (shown when creating new) -->
  <div class="template-selector" *ngIf="!showCreateForm">
    <h2>Choose a Data Source Type</h2>
    <p class="section-description">Select the type of data source you want to connect</p>
    
    <div class="templates-grid">
      <div 
        *ngFor="let template of templates" 
        class="template-card"
        (click)="selectTemplate(template)">
        <div class="template-icon">{{ template.icon }}</div>
        <h3>{{ template.name }}</h3>
        <p>{{ template.description }}</p>
      </div>
    </div>
  </div>

  <!-- Create/Edit Form -->
  <div class="form-panel" *ngIf="showCreateForm">
    <div class="form-header">
      <h2>{{ editingDataSource ? '‚úèÔ∏è Edit' : '‚ûï New' }} Data Source</h2>
      <p class="section-description">
        {{ selectedTemplate ? selectedTemplate.name : editingDataSource?.type || 'Configure connection' }}
      </p>
    </div>

    <div class="form-content">
      <!-- Basic Information -->
      <div class="form-section">
        <h3>Basic Information</h3>
        
        <div class="form-group">
          <label>Name *</label>
          <input 
            type="text" 
            [(ngModel)]="editingDataSource ? editingDataSource.name : newDataSource.name"
            placeholder="e.g., Production Database"
            class="form-input">
        </div>

        <div class="form-group">
          <label>Type</label>
          <select 
            [(ngModel)]="editingDataSource ? editingDataSource.type : newDataSource.type"
            class="form-input"
            [disabled]="!!editingDataSource">
            <option *ngFor="let template of templates" [value]="template.type">
              {{ template.icon }} {{ template.name }}
            </option>
          </select>
        </div>
      </div>

      <!-- Connection Configuration -->
      <div class="form-section">
        <h3>Connection Configuration</h3>

        <!-- Database Configuration -->
        <ng-container *ngIf="['postgresql', 'mysql', 'mongodb'].includes(editingDataSource?.type || newDataSource.type || '')">
          <div class="form-row">
            <div class="form-group">
              <label>Host *</label>
              <input 
                type="text" 
                [(ngModel)]="editingDataSource ? editingDataSource.config.host : newDataSource.config!.host"
                placeholder="localhost"
                class="form-input">
            </div>
            <div class="form-group">
              <label>Port *</label>
              <input 
                type="number" 
                [(ngModel)]="editingDataSource ? editingDataSource.config.port : newDataSource.config!.port"
                placeholder="5432"
                class="form-input">
            </div>
          </div>

          <div class="form-group">
            <label>Database *</label>
            <input 
              type="text" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.database : newDataSource.config!.database"
              placeholder="mydb"
              class="form-input">
          </div>

          <div class="form-group" *ngIf="(editingDataSource?.type || newDataSource.type) === 'postgresql'">
            <label>Schema</label>
            <input 
              type="text" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.schema : newDataSource.config!.schema"
              placeholder="public"
              class="form-input">
          </div>

          <div class="form-group" *ngIf="(editingDataSource?.type || newDataSource.type) === 'mongodb'">
            <label>Collection</label>
            <input 
              type="text" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.collection : newDataSource.config!.collection"
              placeholder="metrics"
              class="form-input">
          </div>

          <div class="form-group">
            <label>Query/Filter (Optional)</label>
            <textarea 
              [(ngModel)]="editingDataSource ? editingDataSource.config.query : newDataSource.config!.query"
              placeholder="SELECT * FROM kpis WHERE date >= NOW() - INTERVAL '7 days'"
              class="form-textarea"
              rows="3"></textarea>
          </div>
        </ng-container>

        <!-- Data Warehouse Configuration -->
        <ng-container *ngIf="(editingDataSource?.type || newDataSource.type) === 'snowflake'">
          <div class="form-group">
            <label>Warehouse *</label>
            <input 
              type="text" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.warehouse : newDataSource.config!.warehouse"
              placeholder="COMPUTE_WH"
              class="form-input">
          </div>
          <div class="form-group">
            <label>Database *</label>
            <input 
              type="text" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.database : newDataSource.config!.database"
              placeholder="ANALYTICS_DB"
              class="form-input">
          </div>
          <div class="form-group">
            <label>Schema</label>
            <input 
              type="text" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.schema : newDataSource.config!.schema"
              placeholder="PUBLIC"
              class="form-input">
          </div>
        </ng-container>

        <ng-container *ngIf="(editingDataSource?.type || newDataSource.type) === 'bigquery'">
          <div class="form-group">
            <label>Project ID *</label>
            <input 
              type="text" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.project : newDataSource.config!.project"
              placeholder="my-gcp-project"
              class="form-input">
          </div>
          <div class="form-group">
            <label>Dataset *</label>
            <input 
              type="text" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.dataset : newDataSource.config!.dataset"
              placeholder="analytics_dataset"
              class="form-input">
          </div>
        </ng-container>

        <!-- API Configuration -->
        <ng-container *ngIf="['rest-api', 'graphql'].includes(editingDataSource?.type || newDataSource.type || '')">
          <div class="form-group">
            <label>API Endpoint *</label>
            <input 
              type="url" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.endpoint : newDataSource.config!.endpoint"
              placeholder="https://api.example.com/v1/metrics"
              class="form-input">
          </div>

          <div class="form-group">
            <label>API Version</label>
            <input 
              type="text" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.apiVersion : newDataSource.config!.apiVersion"
              placeholder="v1"
              class="form-input">
          </div>

          <div class="form-group" *ngIf="(editingDataSource?.type || newDataSource.type) === 'graphql'">
            <label>GraphQL Query</label>
            <textarea 
              [(ngModel)]="editingDataSource ? editingDataSource.config.query : newDataSource.config!.query"
              placeholder="{ metrics { name value } }"
              class="form-textarea"
              rows="4"></textarea>
          </div>
        </ng-container>

        <!-- Cloud Service Configuration -->
        <ng-container *ngIf="['aws-cloudwatch', 'azure-monitor', 'gcp-monitoring'].includes(editingDataSource?.type || newDataSource.type || '')">
          <div class="form-group">
            <label>Region *</label>
            <input 
              type="text" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.region : newDataSource.config!.region"
              placeholder="us-east-1"
              class="form-input">
          </div>

          <div class="form-group" *ngIf="(editingDataSource?.type || newDataSource.type) === 'aws-cloudwatch'">
            <label>Namespace</label>
            <input 
              type="text" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.namespace : newDataSource.config!.namespace"
              placeholder="AWS/EC2"
              class="form-input">
          </div>

          <div class="form-group" *ngIf="(editingDataSource?.type || newDataSource.type) === 'gcp-monitoring'">
            <label>Project ID</label>
            <input 
              type="text" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.project : newDataSource.config!.project"
              placeholder="my-gcp-project"
              class="form-input">
          </div>
        </ng-container>

        <!-- SaaS Configuration -->
        <ng-container *ngIf="(editingDataSource?.type || newDataSource.type) === 'salesforce'">
          <div class="form-group">
            <label>Instance URL *</label>
            <input 
              type="url" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.instanceUrl : newDataSource.config!.instanceUrl"
              placeholder="https://your-domain.salesforce.com"
              class="form-input">
          </div>
          <div class="form-group">
            <label>API Version</label>
            <input 
              type="text" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.apiVersion : newDataSource.config!.apiVersion"
              placeholder="v57.0"
              class="form-input">
          </div>
        </ng-container>

        <ng-container *ngIf="(editingDataSource?.type || newDataSource.type) === 'hubspot'">
          <div class="form-group">
            <label>API Endpoint *</label>
            <input 
              type="url" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.endpoint : newDataSource.config!.endpoint"
              placeholder="https://api.hubapi.com"
              class="form-input">
          </div>
        </ng-container>

        <!-- General Settings -->
        <div class="form-row">
          <div class="form-group">
            <label>Refresh Interval (minutes)</label>
            <input 
              type="number" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.refreshInterval : newDataSource.config!.refreshInterval"
              placeholder="5"
              class="form-input">
          </div>
          <div class="form-group">
            <label>Timeout (seconds)</label>
            <input 
              type="number" 
              [(ngModel)]="editingDataSource ? editingDataSource.config.timeout : newDataSource.config!.timeout"
              placeholder="30"
              class="form-input">
          </div>
        </div>
      </div>

      <!-- Credentials -->
      <div class="form-section credentials-section">
        <div class="section-header">
          <h3>üîí Credentials</h3>
          <button 
            class="mat-btn mat-btn-text"
            (click)="showCredentialsForm = !showCredentialsForm">
            {{ showCredentialsForm ? 'üîº Hide' : 'üîΩ Show' }}
          </button>
        </div>

        <div class="credentials-form" *ngIf="showCredentialsForm">
          <!-- Basic Auth -->
          <ng-container *ngIf="['postgresql', 'mysql', 'mongodb', 'snowflake'].includes(editingDataSource?.type || newDataSource.type || '')">
            <div class="form-row">
              <div class="form-group">
                <label>Username</label>
                <input 
                  type="text" 
                  [(ngModel)]="editingDataSource ? editingDataSource.credentials.username : newDataSource.credentials!.username"
                  placeholder="database_user"
                  class="form-input"
                  autocomplete="off">
              </div>
              <div class="form-group">
                <label>Password</label>
                <input 
                  type="password" 
                  [(ngModel)]="editingDataSource ? editingDataSource.credentials.password : newDataSource.credentials!.password"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  class="form-input"
                  autocomplete="new-password">
              </div>
            </div>
          </ng-container>

          <!-- API Key -->
          <ng-container *ngIf="['rest-api', 'graphql', 'hubspot'].includes(editingDataSource?.type || newDataSource.type || '')">
            <div class="form-group">
              <label>API Key</label>
              <input 
                type="password" 
                [(ngModel)]="editingDataSource ? editingDataSource.credentials.apiKey : newDataSource.credentials!.apiKey"
                placeholder="your-api-key"
                class="form-input"
                autocomplete="off">
            </div>
          </ng-container>

          <!-- OAuth (Salesforce) -->
          <ng-container *ngIf="(editingDataSource?.type || newDataSource.type) === 'salesforce'">
            <div class="form-group">
              <label>Access Token</label>
              <input 
                type="password" 
                [(ngModel)]="editingDataSource ? editingDataSource.credentials.accessToken : newDataSource.credentials!.accessToken"
                placeholder="OAuth access token"
                class="form-input">
            </div>
            <div class="form-group">
              <label>Refresh Token</label>
              <input 
                type="password" 
                [(ngModel)]="editingDataSource ? editingDataSource.credentials.refreshToken : newDataSource.credentials!.refreshToken"
                placeholder="OAuth refresh token"
                class="form-input">
            </div>
          </ng-container>

          <!-- AWS Credentials -->
          <ng-container *ngIf="(editingDataSource?.type || newDataSource.type) === 'aws-cloudwatch'">
            <div class="form-group">
              <label>Access Key ID</label>
              <input 
                type="password" 
                [(ngModel)]="editingDataSource ? editingDataSource.credentials.accessKeyId : newDataSource.credentials!.accessKeyId"
                placeholder="AKIAIOSFODNN7EXAMPLE"
                class="form-input">
            </div>
            <div class="form-group">
              <label>Secret Access Key</label>
              <input 
                type="password" 
                [(ngModel)]="editingDataSource ? editingDataSource.credentials.secretAccessKey : newDataSource.credentials!.secretAccessKey"
                placeholder="wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
                class="form-input">
            </div>
          </ng-container>

          <!-- Azure/GCP Service Account -->
          <ng-container *ngIf="['azure-monitor', 'gcp-monitoring', 'bigquery', 'google-analytics'].includes(editingDataSource?.type || newDataSource.type || '')">
            <div class="form-group">
              <label>{{ (editingDataSource?.type || newDataSource.type) === 'azure-monitor' ? 'Client ID' : 'Service Account Key (JSON)' }}</label>
              <textarea 
                [(ngModel)]="editingDataSource ? editingDataSource.credentials.serviceAccountKey : newDataSource.credentials!.serviceAccountKey"
                placeholder="{{ (editingDataSource?.type || newDataSource.type) === 'azure-monitor' ? 'your-client-id' : '{ \"type\": \"service_account\", ... }' }}"
                class="form-textarea"
                rows="4"></textarea>
            </div>
            <div class="form-group" *ngIf="(editingDataSource?.type || newDataSource.type) === 'azure-monitor'">
              <label>Client Secret</label>
              <input 
                type="password" 
                [(ngModel)]="editingDataSource ? editingDataSource.credentials.clientSecret : newDataSource.credentials!.clientSecret"
                placeholder="your-client-secret"
                class="form-input">
            </div>
          </ng-container>

          <div class="credentials-warning">
            <span class="warning-icon">‚ö†Ô∏è</span>
            <span>Credentials are encrypted and stored securely. Never share your credentials.</span>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button class="mat-btn mat-btn-text" (click)="cancelEdit()">
          Cancel
        </button>
        <button 
          class="mat-btn mat-btn-outlined"
          (click)="editingDataSource ? testConnection(editingDataSource) : null"
          [disabled]="!editingDataSource">
          üß™ Test Connection
        </button>
        <button 
          class="mat-btn mat-btn-filled"
          (click)="editingDataSource ? updateDataSource() : createDataSource()">
          {{ editingDataSource ? 'üíæ Update' : '‚ûï Create' }}
        </button>
      </div>

      <!-- Test Result -->
      <div class="test-result" *ngIf="testResult">
        <div class="test-result-header" [class.success]="testResult.success" [class.error]="!testResult.success">
          <span class="result-icon">{{ testResult.success ? '‚úÖ' : '‚ùå' }}</span>
          <span class="result-message">{{ testResult.message }}</span>
        </div>
        <div class="test-result-details" *ngIf="testResult.success">
          <div class="detail-item" *ngIf="testResult.responseTime">
            <span class="detail-label">Response Time:</span>
            <span class="detail-value">{{ testResult.responseTime }}ms</span>
          </div>
          <div class="detail-item" *ngIf="testResult.recordCount !== undefined">
            <span class="detail-label">Records Found:</span>
            <span class="detail-value">{{ testResult.recordCount }}</span>
          </div>
          <div class="detail-item" *ngIf="testResult.sampleData?.length">
            <span class="detail-label">Sample Data:</span>
            <pre class="sample-data">{{ testResult.sampleData | json }}</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Sources List -->
  <div class="data-sources-list" *ngIf="!showCreateForm">
    <!-- Filters -->
    <div class="filters-panel">
      <div class="search-box">
        <input 
          type="text" 
          [(ngModel)]="searchQuery" 
          placeholder="üîç Search data sources..."
          class="search-input">
      </div>

      <select [(ngModel)]="filterType" class="filter-select">
        <option value="">All Types</option>
        <option *ngFor="let type of uniqueTypes" [value]="type">
          {{ getTypeIcon(type) }} {{ type }}
        </option>
      </select>

      <label class="checkbox-label">
        <input type="checkbox" [(ngModel)]="showConnectedOnly">
        <span>Connected Only</span>
      </label>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredDataSources.length === 0 && dataSources.length === 0">
      <div class="empty-icon">üîå</div>
      <h3>No Data Sources Yet</h3>
      <p>Click "Add Data Source" to connect your first data source</p>
    </div>

    <div class="empty-state" *ngIf="filteredDataSources.length === 0 && dataSources.length > 0">
      <div class="empty-icon">üîç</div>
      <h3>No Results Found</h3>
      <p>Try adjusting your filters</p>
    </div>

    <!-- Data Source Cards -->
    <div class="sources-grid">
      <div *ngFor="let dataSource of filteredDataSources" class="source-card">
        <!-- Card Header -->
        <div class="source-header">
          <div class="source-title">
            <span class="source-icon">{{ getTypeIcon(dataSource.type) }}</span>
            <div class="source-info">
              <h3>{{ dataSource.name }}</h3>
              <p class="source-type">{{ dataSource.type }}</p>
            </div>
          </div>
          <div class="source-status" [style.color]="getStatusColor(dataSource.status)">
            <span class="status-icon">{{ getStatusIcon(dataSource.status) }}</span>
            <span class="status-text">{{ dataSource.status }}</span>
          </div>
        </div>

        <!-- Card Details -->
        <div class="source-details">
          <div class="detail-row" *ngIf="dataSource.config.host">
            <span class="detail-label">Host:</span>
            <span class="detail-value">{{ dataSource.config.host }}:{{ dataSource.config.port }}</span>
          </div>
          <div class="detail-row" *ngIf="dataSource.config.endpoint">
            <span class="detail-label">Endpoint:</span>
            <span class="detail-value">{{ dataSource.config.endpoint }}</span>
          </div>
          <div class="detail-row" *ngIf="dataSource.config.database">
            <span class="detail-label">Database:</span>
            <span class="detail-value">{{ dataSource.config.database }}</span>
          </div>
          <div class="detail-row" *ngIf="dataSource.metadata.lastConnected">
            <span class="detail-label">Last Connected:</span>
            <span class="detail-value">{{ formatDate(dataSource.metadata.lastConnected) }}</span>
          </div>
          <div class="detail-row" *ngIf="dataSource.metadata.lastSync">
            <span class="detail-label">Last Sync:</span>
            <span class="detail-value">{{ formatDate(dataSource.metadata.lastSync) }}</span>
          </div>
          <div class="detail-row" *ngIf="dataSource.metadata.recordCount">
            <span class="detail-label">Records:</span>
            <span class="detail-value">{{ dataSource.metadata.recordCount }}</span>
          </div>
        </div>

        <!-- Card Actions -->
        <div class="source-actions">
          <button 
            class="action-btn test-btn"
            (click)="testConnection(dataSource)"
            [disabled]="testingDataSource?.id === dataSource.id"
            title="Test Connection">
            {{ testingDataSource?.id === dataSource.id ? '‚è≥' : 'üß™' }} Test
          </button>
          <button 
            class="action-btn sync-btn"
            (click)="syncDataSource(dataSource)"
            [disabled]="dataSource.status !== 'connected'"
            title="Sync Data">
            üîÑ Sync
          </button>
          <button 
            class="action-btn fetch-btn"
            (click)="fetchData(dataSource)"
            [disabled]="dataSource.status !== 'connected'"
            title="Fetch Data">
            üì• Fetch
          </button>
          <button 
            class="action-btn edit-btn"
            (click)="editDataSource(dataSource)"
            title="Edit">
            ‚úèÔ∏è Edit
          </button>
          <button 
            class="action-btn delete-btn"
            (click)="deleteDataSource(dataSource)"
            title="Delete">
            üóëÔ∏è
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
