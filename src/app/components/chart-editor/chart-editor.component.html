<div class="modal-overlay" (click)="cancel()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        <span>{{ isEditMode ? 'âœï¸' : 'â•' }}</span>
        {{ isEditMode ? 'Edit Chart' : 'Create New Chart' }}
      </h2>
      <button class="close-btn" (click)="cancel()">âœ•</button>
    </div>

    <div class="modal-body">
      <!-- Basic Information -->
      <section class="form-section">
        <h3>ğŸ“‹ Basic Information</h3>
        
        <div class="form-group">
          <label>Chart Name *</label>
          <input 
            type="text" 
            [(ngModel)]="chart.name" 
            placeholder="e.g., Revenue Trend, Sales by Region"
            class="form-input">
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea 
            [(ngModel)]="chart.description"
            placeholder="Brief description of this chart"
            class="form-textarea"
            rows="2"></textarea>
        </div>

        <div class="form-group">
          <label>Chart Type *</label>
          <div class="chart-type-selector">
            <button 
              type="button"
              class="chart-type-btn"
              [class.selected]="chart.chartType === 'line'"
              (click)="chart.chartType = 'line'">
              <span class="chart-icon">ğŸ“ˆ</span>
              <span>Line</span>
            </button>
            <button 
              type="button"
              class="chart-type-btn"
              [class.selected]="chart.chartType === 'bar'"
              (click)="chart.chartType = 'bar'">
              <span class="chart-icon">ğŸ“Š</span>
              <span>Bar</span>
            </button>
            <button 
              type="button"
              class="chart-type-btn"
              [class.selected]="chart.chartType === 'pie'"
              (click)="chart.chartType = 'pie'">
              <span class="chart-icon">ğŸ¥§</span>
              <span>Pie</span>
            </button>
            <button 
              type="button"
              class="chart-type-btn"
              [class.selected]="chart.chartType === 'area'"
              (click)="chart.chartType = 'area'">
              <span class="chart-icon">ğŸ“‰</span>
              <span>Area</span>
            </button>
            <button 
              type="button"
              class="chart-type-btn"
              [class.selected]="chart.chartType === 'doughnut'"
              (click)="chart.chartType = 'doughnut'">
              <span class="chart-icon">ğŸ©</span>
              <span>Doughnut</span>
            </button>
          </div>
        </div>
      </section>

      <!-- Data Source Configuration -->
      <section class="form-section">
        <h3>ğŸ”Œ Data Source</h3>
        
        <div class="form-group">
          <label>Source Type *</label>
          <select 
            [(ngModel)]="selectedDataSourceType"
            (ngModelChange)="onDataSourceTypeChange()"
            class="form-select">
            <option value="static">Static Data</option>
            <option value="datasource">Data Source</option>
            <option value="calculated">Calculated</option>
          </select>
        </div>

        <!-- Static Data -->
        <div *ngIf="selectedDataSourceType === 'static'" class="static-data-config">
          <label>Data Points</label>
          
          <div class="data-points-list">
            <div *ngFor="let point of chart.dataSource!.staticData; let i = index" class="data-point-item">
              <span class="point-label">{{ point.label }}</span>
              <span class="point-value">{{ point.value }}</span>
              <button class="remove-btn" (click)="removeStaticDataPoint(i)">âœ•</button>
            </div>
            <div *ngIf="!chart.dataSource!.staticData || chart.dataSource!.staticData.length === 0" class="no-data">
              No data points yet. Add some below.
            </div>
          </div>

          <div class="add-data-point">
            <input 
              type="text" 
              [(ngModel)]="newLabel"
              placeholder="Label (e.g., Jan)"
              class="form-input small">
            <input 
              type="number" 
              [(ngModel)]="newValue"
              placeholder="Value"
              class="form-input small">
            <button class="mat-btn mat-btn-outlined" (click)="addStaticDataPoint()">
              â• Add
            </button>
          </div>
        </div>

        <!-- Data Source Selection -->
        <div *ngIf="selectedDataSourceType === 'datasource'">
          <div class="form-group">
            <label>Select Data Source *</label>
            <select 
              [(ngModel)]="selectedDataSourceId"
              (ngModelChange)="onDataSourceIdChange()"
              class="form-select">
              <option value="">-- Select Data Source --</option>
              <option *ngFor="let ds of dataSources" [value]="ds.id">
                {{ ds.name }} ({{ ds.type }})
              </option>
            </select>
            <small *ngIf="dataSources.length === 0" class="text-warning">
              No data sources configured. Go to <a routerLink="/data-sources">Data Sources</a> to add one.
            </small>
          </div>

          <div *ngIf="selectedDataSourceId" class="data-source-config">
            <div class="form-group">
              <label>Query / Endpoint</label>
              <textarea 
                [(ngModel)]="chart.dataSource!.query"
                placeholder="SELECT date, SUM(amount) FROM sales GROUP BY date"
                class="form-textarea"
                rows="3"></textarea>
              <small>SQL query or API endpoint to fetch chart data</small>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Table Name</label>
                <input 
                  type="text" 
                  [(ngModel)]="chart.dataSource!.tableName"
                  placeholder="sales"
                  class="form-input">
              </div>

              <div class="form-group">
                <label>JSON Path</label>
                <input 
                  type="text" 
                  [(ngModel)]="chart.dataSource!.jsonPath"
                  placeholder="data.chart"
                  class="form-input">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>X-Axis Column</label>
                <input 
                  type="text" 
                  [(ngModel)]="chart.dataSource!.xAxisColumn"
                  placeholder="date"
                  class="form-input">
              </div>

              <div class="form-group">
                <label>Y-Axis Column</label>
                <input 
                  type="text" 
                  [(ngModel)]="chart.dataSource!.yAxisColumn"
                  placeholder="total"
                  class="form-input">
              </div>
            </div>
          </div>
        </div>

        <!-- Test Connection -->
        <div class="form-actions">
          <button 
            class="mat-btn mat-btn-outlined"
            (click)="testConnection()"
            [disabled]="isTesting">
            {{ isTesting ? 'â³ Testing...' : 'ğŸ§ª Test Data Source' }}
          </button>
        </div>

        <div *ngIf="testResult" class="test-result" [class.success]="testResult.success" [class.error]="!testResult.success">
          <div class="result-icon">{{ testResult.success ? 'âœ…' : 'âŒ' }}</div>
          <div class="result-content">
            <div class="result-message">{{ testResult.message }}</div>
            <div *ngIf="testResult.dataPoints !== undefined" class="result-value">
              Data Points: <strong>{{ testResult.dataPoints }}</strong>
            </div>
          </div>
        </div>
      </section>

      <!-- Styling -->
      <section class="form-section">
        <h3>ğŸ¨ Styling</h3>

        <div class="form-group">
          <label>Color Scheme</label>
          <div class="color-schemes">
            <button 
              *ngFor="let scheme of colorSchemes"
              type="button"
              class="color-scheme-btn"
              (click)="applyColorScheme(scheme.colors)"
              [title]="scheme.name">
              <div class="color-preview">
                <span *ngFor="let color of scheme.colors" 
                      [style.background-color]="color"
                      class="color-dot"></span>
              </div>
              <span>{{ scheme.name }}</span>
            </button>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Border Width</label>
            <input 
              type="number" 
              [(ngModel)]="chart.styling!.borderWidth"
              min="0"
              max="10"
              class="form-input">
          </div>

          <div class="form-group" *ngIf="chart.chartType === 'line' || chart.chartType === 'area'">
            <label>Line Smoothness (Tension)</label>
            <input 
              type="number" 
              [(ngModel)]="chart.styling!.tension"
              min="0"
              max="1"
              step="0.1"
              class="form-input">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group checkbox-group">
            <label>
              <input 
                type="checkbox" 
                [(ngModel)]="chart.styling!.fill">
              Fill area under line
            </label>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input 
                type="checkbox" 
                [(ngModel)]="chart.styling!.showLegend">
              Show legend
            </label>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input 
                type="checkbox" 
                [(ngModel)]="chart.styling!.showGrid">
              Show grid lines
            </label>
          </div>
        </div>
      </section>

      <!-- Axes Configuration -->
      <section class="form-section">
        <h3>ğŸ“ Axes</h3>
        
        <div class="form-row">
          <div class="form-group">
            <label>X-Axis Label</label>
            <input 
              type="text" 
              [(ngModel)]="chart.axes!.xAxis!.label"
              placeholder="Time, Category, etc."
              class="form-input">
          </div>

          <div class="form-group">
            <label>X-Axis Type</label>
            <select [(ngModel)]="chart.axes!.xAxis!.type" class="form-select">
              <option value="category">Category</option>
              <option value="time">Time</option>
              <option value="linear">Linear</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Y-Axis Label</label>
            <input 
              type="text" 
              [(ngModel)]="chart.axes!.yAxis!.label"
              placeholder="Value, Amount, etc."
              class="form-input">
          </div>

          <div class="form-group">
            <label>Y-Axis Min Value</label>
            <input 
              type="number" 
              [(ngModel)]="chart.axes!.yAxis!.min"
              placeholder="0"
              class="form-input">
          </div>

          <div class="form-group">
            <label>Y-Axis Max Value</label>
            <input 
              type="number" 
              [(ngModel)]="chart.axes!.yAxis!.max"
              placeholder="Auto"
              class="form-input">
          </div>
        </div>
      </section>

      <!-- Visibility -->
      <section class="form-section">
        <h3>ğŸ‘ï¸ Visibility</h3>
        
        <div class="form-group checkbox-group">
          <label>
            <input 
              type="checkbox" 
              [(ngModel)]="chart.visible">
            Show this chart on dashboard
          </label>
        </div>
      </section>
    </div>

    <div class="modal-footer">
      <button 
        *ngIf="isEditMode"
        class="mat-btn mat-btn-danger"
        (click)="deleteChart()">
        ğŸ—‘ï¸ Delete Chart
      </button>
      <div class="spacer"></div>
      <button class="mat-btn mat-btn-text" (click)="cancel()">
        Cancel
      </button>
      <button class="mat-btn mat-btn-filled" (click)="save()">
        ğŸ’¾ {{ isEditMode ? 'Save Changes' : 'Create Chart' }}
      </button>
    </div>
  </div>
</div>
