<div class="dashboard-container">
  <!-- Header -->
  <header class="clean-header">
    <div class="clean-header-content">
      <div class="clean-header-title">
        <h1><span style="opacity: 0.8;">üìä</span> KPI Dashboard</h1>
        <p>Monitor your key performance indicators</p>
      </div>
      <div class="clean-header-actions">
        <app-organization-selector></app-organization-selector>
        
        <div class="period-selector" role="group" aria-label="Select time period">
          <button
            class="mat-btn mat-btn-text"
            [class.mat-btn-filled]="selectedPeriod === 'week'"
            (click)="onPeriodChange('week')"
            [attr.aria-pressed]="selectedPeriod === 'week'"
            aria-label="View weekly data">
            Week
          </button>
          <button
            class="mat-btn mat-btn-text"
            [class.mat-btn-filled]="selectedPeriod === 'month'"
            (click)="onPeriodChange('month')"
            [attr.aria-pressed]="selectedPeriod === 'month'"
            aria-label="View monthly data">
            Month
          </button>
          <button
            class="mat-btn mat-btn-text"
            [class.mat-btn-filled]="selectedPeriod === 'year'"
            (click)="onPeriodChange('year')"
            [attr.aria-pressed]="selectedPeriod === 'year'"
            aria-label="View yearly data">
            Year
          </button>
        </div>

        <app-date-range-picker (dateRangeSelected)="onDateRangeSelected($event)"></app-date-range-picker>
        
        <div class="export-dropdown">
          <button 
            class="mat-btn mat-btn-outlined" 
            (click)="toggleExportMenu()"
            aria-label="Export dashboard data"
            aria-haspopup="true"
            [attr.aria-expanded]="showExportMenu">
            <span>üì•</span> Export
          </button>
          <div class="export-menu" *ngIf="showExportMenu" role="menu">
            <button class="mat-btn mat-btn-text" (click)="exportToCSV()" role="menuitem">
              <span>üìÑ</span> CSV
            </button>
            <button class="mat-btn mat-btn-text" (click)="exportToExcel()" role="menuitem">
              <span>üìä</span> Excel
            </button>
            <button class="mat-btn mat-btn-text" (click)="exportToPDF()" role="menuitem">
              <span>üìë</span> PDF
            </button>
          </div>
        </div>

        <button class="mat-icon-btn" routerLink="/builder" aria-label="Customize dashboard" title="Customize">
          üé®
        </button>
        <button class="mat-icon-btn" routerLink="/admin" aria-label="Admin panel" title="Admin">
          ‚öôÔ∏è
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="dashboard-main">
    <!-- Loading Skeletons -->
    <div *ngIf="isLoading">
      <app-loading-skeleton type="kpi" [count]="4"></app-loading-skeleton>
      <div class="charts-grid" style="margin-top: 2rem;">
        <app-loading-skeleton type="chart"></app-loading-skeleton>
        <app-loading-skeleton type="chart"></app-loading-skeleton>
      </div>
      <div style="margin-top: 2rem;">
        <app-loading-skeleton type="chart"></app-loading-skeleton>
      </div>
    </div>

    <!-- Actual Content -->
    <div *ngIf="!isLoading" [@fadeIn]>
      <!-- Dynamic Widget Layout -->
      <div class="dashboard-grid">
        <ng-container *ngFor="let widget of widgets">
          <!-- KPI Cards -->
          <div *ngIf="widget.type === 'kpi'" [ngStyle]="getWidgetStyle(widget)" class="widget-item">
            <div class="kpi-grid">
              <app-kpi-card *ngFor="let kpi of kpiData" [kpi]="kpi"></app-kpi-card>
            </div>
          </div>

          <!-- Revenue Chart -->
          <div *ngIf="widget.type === 'chart-revenue'" [ngStyle]="getWidgetStyle(widget)" class="widget-item">
            <div class="chart-container">
              <app-revenue-chart [data]="revenueData" [period]="selectedPeriod"></app-revenue-chart>
            </div>
          </div>

          <!-- Sales Chart -->
          <div *ngIf="widget.type === 'chart-sales'" [ngStyle]="getWidgetStyle(widget)" class="widget-item">
            <div class="chart-container">
              <app-sales-chart [data]="salesData" [period]="selectedPeriod"></app-sales-chart>
            </div>
          </div>

          <!-- Conversion Chart -->
          <div *ngIf="widget.type === 'chart-conversion'" [ngStyle]="getWidgetStyle(widget)" class="widget-item">
            <div class="chart-container">
              <app-conversion-chart [data]="conversionData" [period]="selectedPeriod"></app-conversion-chart>
            </div>
          </div>

          <!-- Pie Chart -->
          <div *ngIf="widget.type === 'pie'" [ngStyle]="getWidgetStyle(widget)" class="widget-item">
            <div class="chart-container">
              <app-pie-chart title="Revenue by Category"></app-pie-chart>
            </div>
          </div>

          <!-- Goals Tracker -->
          <div *ngIf="widget.type === 'goals'" [ngStyle]="getWidgetStyle(widget)" class="widget-item">
            <app-goal-tracker></app-goal-tracker>
          </div>

          <!-- AI Insights Panel -->
          <div *ngIf="widget.type === 'insights'" [ngStyle]="getWidgetStyle(widget)" class="widget-item">
            <app-insights-panel [kpiData]="kpiData"></app-insights-panel>
          </div>
        </ng-container>
      </div>
    </div>
  </main>

  <!-- Comments Panel (Global) -->
  <app-comments-panel></app-comments-panel>
</div>



